# Instructions for running GEOS-5 (Heracles-5_4) coupled with MITgcm
# https://github.com/christophernhill/gmao_mitgcm_couplng/blob/master/dimitris_notes/Heracles-5_4onLubuntu.txt

# Set up a Lubuntu 16.04 virtual machine under VirtualBox
# Get VirtualBox from here: https://www.virtualbox.org/wiki/Downloads
# Get lubuntu-16.04.1-desktop-amd64.iso from here: https://help.ubuntu.com/community/Lubuntu/GetLubuntu
# Start VirtualBox and set-up virtual machine:
#   New
#     Name: lubuntu-16.04
#     Type: Linux
#     Version: Ubuntu (64-bit)
#     Memory size: 2048 MB
#     Create a virtual hard disk now
#     Hard disk file type: VDI (VirtualBox Disk Image)
#     Storage on physical hard disk: Fixed size
#     File location and size: 16.00 GB
#   Settings
#     General
#       Advanced
#         Shared Clipboard: Bidirectional
#     System/Processor
#       Processors: 4 CPUs; Execution Cap: 100%
#     Storage
#       Controller: IDE (click on circle with green plus)
#       Choose disk: Downloads/lubuntu-16.04.1-desktop-amd64.iso
#   Start

# Install Lubuntu 16.04
#   Download Updates; Install third-party software
#   Erase disk and install Lubuntu
#   Your name: heracles
#   Password: heracles
#   Log in automatically

# Packages needed for VirtualBox to run smoothly
sudo apt install virtualbox-guest-dkms
sudo adduser heracles vboxsf
sudo reboot

# Extra packages needed to get and run MITgcm
sudo apt install cvs
sudo apt install gfortran
sudo apt install libopenmpi-dev

# Extra packages needed to build GEOS-5 baselibs
sudo apt install g++
sudo apt-get install bison
sudo apt-get install flex
sudo apt-get install libexpat1-dev

# Extra packages needed to compile and run GEOS-5
sudo apt install ksh
sudo apt install tcsh
sudo apt install colordiff
sudo apt-get install libblas-dev
sudo apt-get install liblapack-dev
sudo apt-get install python-dev
sudo apt-get install python-numpy
sudo ln -s /usr/bin/make /usr/bin/gmake

# Useful extra packages
sudo apt install git
sudo apt-get install emacs24

# Install and test latest version of MITgcm
export CVSROOT=':pserver:cvsanon@mitgcm.org:/u/gcmpack'
cvs login # enter the CVS password: "cvsanon"
cvs co MITgcm_code
cvs co MITgcm/verification/testreport
cvs co MITgcm/verification/tutorial_held_suarez_cs
cvs co MITgcm/verification/global_ocean.cs32x15
cd MITgcm/verification
./testreport -j 4 -t global_ocean.cs32x15
export MPI_INC_DIR=/usr/lib/openmpi/include
./testreport -j 4 -mpi -t global_ocean.cs32x15

# Get files needed for building/running GEOS-5 and coupled code
# They are available on
#   engaging:/nobackup1/dmenemen/geos5/tarballs_100816
#   discover:/discover/nobackup/dmenemen/geos5/tarballs_100816
# Instructions below assume that tarballs_100816 has been copied to ~/geos5

# Build GEOS-5 baselibs
cd ~/geos5
tar xf tarballs_100816/GMAO-Baselibs-4_0_7.withNewCDO.tgz
cd GMAO-Baselibs-4_0_7/src
make -j 4 install ESMF_COMM=openmpi |& tee makeinstall.log


PART 1
====
Add this to your $HOME/.ssh/config

host discover dirac dali
User YOUR-USER-ID
LogLevel Quiet
ProxyCommand ssh -l YOUR-USER_ID login.nccs.nasa.gov direct %h.nccs.nasa.gov
Protocol 2
ConnectTimeout 30

Of course, replace YOUR-USER-ID with your real user id on discover

PART 2
====
git clone discover:/discover/swdev/adasilva/bridge/GEOSodas

PART 3
====
git checkout -b b_geos5mit remotes/origin/b_geos5mit




cd ....


https://github.com/christophernhill/gmao_mitgcm_couplng/blob/sync_to_current_mitgcm/notes/chris_notes/howto_work_from_gmao_mitgcm_couplng.md


tcsh
setenv ESMADIR /mnt/scratch/heracles/hhome/geos5/GEOSodas
cd ${ESMADIR}/src/GEOSgcs_GridComp/GEOSgcm_GridComp/GEOSogcm_GridComp/GEOSocean_GridComp/GuestOcean_GridComp
git clone git@github.com:christophernhill/gmao_mitgcm_couplng.git
cd gmao_mitgcm_couplng
git checkout
git checkout sync_to_current_mitgcm
setenv MITGCM_ROOT /home/heracles/MITgcm
./set_mitgcm_env.sh




# Build coupled GEOS-5 + MITgcm
tcsh
cd ~/geos5
tar xf tarballs_100816/GEOSodas.tgz
cp tarballs_100816/g5_modules GEOSodas/src
cp tarballs_100816/ESMA_arch.mk GEOSodas/src/Config
cd GEOSodas/src
source g5_modules
cd $ESMADIR/src/GEOSgcs_GridComp/GEOSgcm_GridComp/GEOSogcm_GridComp/GEOSocean_GridComp/GuestOcean_GridComp/mit/mitgcm_setup/build
ln -sf /usr/lib/openmpi/include/mpif.h .
cd $ESMADIR/src
gmake install -j 4 |& tee makeinstall1.log    # ~16 minutes
gmake install |& tee makeinstall2.log         # ~25 seconds

# Set up coupled code
cd ~/geos5/GEOSodas/src/Applications/GEOSgcm_App
./gcm_setup
# Enter the Experiment ID: TEST
# Enter a 1-line Experiment Description: TEST
# Do you wish to CLONE an old experiment? NO
# Enter the Atmospheric Horizontal Resolution code: c12
# Enter the Atmospheric Model Vertical Resolution: 72
# Do you wish to run the COUPLED Ocean/Sea-Ice Model? YES
# Enter the Ocean Lat/Lon Horizontal Resolution: c32
# Enter the Ocean Model Vertical Resolution: 15
# Enter the choice of  Land Surface Model: 1
# Do you wish to run  the Runoff Routing Model? NO
# Do you wish to run GOCART with Actual or Climatological Aerosols? C
# Enter the tag or directory: Current
# Enter Desired Location for HOME: /home/heracles/geos5/TEST
# Enter Desired Location for EXPERIMENT: /home/heracles/geos5/TEST
# Enter Location for Build directory: /home/heracles/geos5/GEOSodas
# Enter your GROUP ID for Current EXP: heracles

# Get input files for coupled code
cd ~/geos5
tar -xf tarballs_100816/geos5-tiny.tgz
cd TEST
../tarballs_100816/makeoneday.bash TINY
cp ../tarballs_100816/HISTORY.rc .
ln -sf ../tarballs_100816/mitocean_run.tgz .

# Run coupled code
setenv GFORTRAN_CONVERT_UNIT 'little_endian:20-25'
./gcm_run.j |&  tee gcm_run.out
