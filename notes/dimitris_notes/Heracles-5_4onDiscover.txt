# Instructions for running GEOS-5 (Heracles-5_4) coupled with MITgcm
# https://github.com/christophernhill/gmao_mitgcm_couplng/blob/master/dimitris_notes/Heracles-5_4onDiscover.txt

# Set varialbe WorkingDir to a location where you have write permission
tcsh
set WorkingDir=/discover/nobackup/dmenemen/Heracles-5_4
cd $WorkingDir

# Get the github files
git clone https://github.com/christophernhill/gmao_mitgcm_couplng
# enter github username and password

# Get GEOS-5 and runtime files from tar archives
tar xf /discover/nobackup/dmenemen/Heracles-5_4/versions/v5/GEOSodas.tgz
tar xf /discover/nobackup/dmenemen/Heracles-5_4/versions/v5/test-mit.tgz

# Get MITgcm code and run verification experiment
setenv ESMADIR $WorkingDir/GEOSodas
source $ESMADIR/src/g5_modules
setenv CVSROOT ':pserver:cvsanon@mitgcm.org:/u/gcmpack'
cvs login
# CVS password: cvsanon
cvs co -D "01/31/07" MITgcm_code
cvs co -D "01/31/07" MITgcm/verification/testreport
cvs co -D "01/31/07" MITgcm/verification/tutorial_held_suarez_cs
cvs co -D "01/31/07" MITgcm/verification/global_ocean.cs32x15
cd MITgcm/verification
./testreport -j 8 -of /discover/nobackup/dmenemen/mitgcm/013107/linux_amd64_ifort_discover -t global_ocean.cs32x15

# create mitocean_run directory
cd $WorkingDir
mkdir mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/bathy_Hmin50.bin mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/data mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/data.gmredi mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/data.pkg mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/eedata mitocean_run
cp MITgcm/verification/tutorial_held_suarez_cs/input/g* mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/lev* mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/pic* mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/shi* mitocean_run
cp MITgcm/verification/global_ocean.cs32x15/input/tre* mitocean_run

# compile and link GEOS5+MITgcm
cd $ESMADIR/src/GEOSgcs_GridComp/GEOSgcm_GridComp/GEOSogcm_GridComp/GEOSocean_GridComp/GuestOcean_GridComp
ln -sf $WorkingDir/MITgcm/eesupp .
ln -sf $WorkingDir/MITgcm/model .
ln -sf $WorkingDir/MITgcm/pkg .
ln -sf $WorkingDir/MITgcm/tools .
cp -r $WorkingDir/gmao_mitgcm_couplng/GuestOcean_GridComp/* .
cd $ESMADIR/src
gmake install | & tee make.log
# takes ~96 minutes to compile on discover07
# ls -l Applications/GEOSgcm_App/GEOSgcm.x

# run GEOS5+MITgcm
cd $WorkingDir/test-mit
ln -sf $ESMADIR/src/Applications/GEOSgcm_App/GEOSgcm.x .
./gcm_run.j $WorkingDir | & tee gcm_run.out
# takes ~2 minutes to run with example output in:
# /discover/nobackup/dmenemen/Heracles-5_4/version/v5/gcm_run.out
# /discover/nobackup/dmenemen/Heracles-5_4/version/v5/scratch.tgz
