# Instructions for running GEOS-5 (Heracles-5_4) coupled to MITgcm on Discover
# https://github.com/christophernhill/gmao_mitgcm_couplng/blob/master/notes/dimitris_notes/Heracles-5_4onDiscover.txt

# Start tcsh and set $WorkingDir to a location where you have write permission
tcsh
setenv WorkingDir /discover/nobackup/dmenemen/Heracles-5_4
mkdir $WorkingDir

# Get GEOS-5
# For instructions below to work, you need to:
# (i) have an account on engaging,
# (ii) have correct id_rsa key in ~/.ssh, and
# (iii) replace "dmenemen" with your engaging username.
cd $WorkingDir
git clone dmenemen@eofe4.mit.edu:/pool001/cnh/geos5mit_write/GEOSodas.git
cd GEOSodas
git checkout b_geos5mit

# Get GEOS-5 to MITgcm coupling code
# For instructions below to work, you need to:
# (i) have a github account and
# (ii) have been granted access to https://github.com/christophernhill/gmao_mitgcm_couplng
cd $WorkingDir/GEOSodas/src/GEOSgcs_GridComp/GEOSgcm_GridComp
cd GEOSogcm_GridComp/GEOSocean_GridComp/GuestOcean_GridComp
git clone https://github.com/christophernhill/gmao_mitgcm_couplng

# Get MITgcm from anonymous CVS server
cd $WorkingDir
setenv CVSROOT :pserver:cvsanon@mitgcm.org:/u/gcmpack
cvs login                         # enter the CVS password: "cvsanon"
cvs co -D "01/31/07" MITgcm_code
cvs co -D "01/31/07" MITgcm/verification/testreport
cvs co -D "01/31/07" MITgcm/verification/tutorial_held_suarez_cs
cvs co -D "01/31/07" MITgcm/verification/global_ocean.cs32x15

# Request node and reset WorkingDir to same location as above
xsub -I -l select=1,walltime=8:00:00
tcsh
setenv WorkingDir /discover/nobackup/dmenemen/Heracles-5_4

# Set GEOS-5 and MITgcm environment variables
cd $WorkingDir/GEOSodas/src
source g5_modules
setenv ESMA_NOCVS
setenv MITGCM_ROOT $WorkingDir/MITgcm
setenv GMAO_MITGCM_COUPLNG $WorkingDir/GEOSodas/src/GEOSgcs_GridComp/GEOSgcm_GridComp/GEOSogcm_GridComp/GEOSocean_GridComp/GuestOcean_GridComp/gmao_mitgcm_couplng
cd $GMAO_MITGCM_COUPLNG
./set_mitgcm_env.sh
setenv MPI_INC_DIR /usr/local/other/SLES11.1/mvapich2/1.8.1/intel-13.1.2.183/include

# Run MITgcm verification experiment
# This is needed to create some MITgcm exchange files
# and a Makefile that can be modified for coupled code
cd $WorkingDir/MITgcm/verification
./testreport -mpi -j 4 -of $GMAO_MITGCM_COUPLNG/modifications/linux_amd64_ifort_discover -t global_ocean.cs32x15
cd global_ocean.cs32x15/build
mpirun -np 2 ./mitgcmuv

# Apply Atanas' changes to MITgcm"
cd $GMAO_MITGCM_COUPLNG/modifications
cp timers.F $WorkingDir/MITgcm/eesupp/src

# Build coupled GEOS-5 + MITgcm.
# For Makefile recipe, compare
# $GMAO_MITGCM_COUPLNG/mitgcm_setup/build/Makefile to
# $MITGCM_ROOT/verification/global_ocean.cs32x15/build/Makefile
# Approximately 16 minutes with "-j 16".
# If the build is successful, it will create:
# $ESMADIR/src/Applications/GEOSgcm_App/GEOSgcm.x
cd $GMAO_MITGCM_COUPLNG/mitgcm_setup/build
ln -sf Makefile_ifort Makefile
cd $ESMADIR/src
gmake pinstall -j 16 |& tee makeinstall.log 

# Set up coupled code
cd $ESMADIR/src/Applications/GEOSgcm_App
./gcm_setup
# Enter the Experiment ID: TEST
# Enter a 1-line Experiment Description: TEST
# Do you wish to CLONE an old experiment? NO
# Enter the Atmospheric Horizontal Resolution code: c12
# Enter the Atmospheric Model Vertical Resolution: 72
# Do you wish to run the COUPLED Ocean/Sea-Ice Model? YES
# Enter the Ocean Lat/Lon Horizontal Resolution: c32
# Enter the Ocean Model Vertical Resolution: 15
# Enter the choice of  Land Surface Model: 1
# Do you wish to run  the Runoff Routing Model? NO
# Do you wish to run GOCART with Actual or Climatological Aerosols? C
# Enter the tag or directory: Current
# Enter Desired Location for HOME: /home/heracles/geos5/TEST
# Enter Desired Location for EXPERIMENT: /home/heracles/geos5/TEST
# Enter Location for Build directory: /home/heracles/geos5/GEOSodas
# Enter your GROUP ID for Current EXP: s1353

# Get GEOS-5 boundary conditions
cd $WorkingDir
tar -xf /discover/nobackup/dmenemen/geos5/tarballs_100816/geos5-tiny.tgz
cd $WorkingDir/TEST
$GMAO_MITGCM_COUPLNG/modifications/makeoneday.bash TINY
cp $GMAO_MITGCM_COUPLNG/modifications/HISTORY.rc .

# Run coupled code
# Some verification output in $GMAO_MITGCM_COUPLNG/verification
cd $WorkingDir/TEST
./gcm_run.j |&  tee gcm_run.out



#===========================================================================
# Get and test latest MITgcm (bash)
export CVSROOT=:pserver:cvsanon@mitgcm.org:/u/gcmpack
cvs login # enter the CVS password: "cvsanon"
cvs co MITgcm_code
cvs co MITgcm/verification/testreport
cvs co MITgcm/verification/tutorial_held_suarez_cs
cvs co MITgcm/verification/global_ocean.cs32x15
cd MITgcm/verification
./testreport -j 4 -of ../tools/build_options/linux_amd64_ifort_discover -t global_ocean.cs32x15
./testreport -j 4 -of ../tools/build_options/linux_amd64_ifort_discover -mpi -t global_ocean.cs32x15
